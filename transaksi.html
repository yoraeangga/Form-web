<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transaksi</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4">
  <div class="max-w-3xl mx-auto bg-white shadow-lg rounded-2xl p-6">
    <h1 id="title" class="text-2xl font-bold mb-4 text-gray-800"></h1>

    <div id="form-section" class="space-y-4">
      <!-- Barang list -->
      <div id="barang-list" class="space-y-3"></div>

      <button id="add-barang" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ Tambah Barang</button>

      <!-- Total -->
      <div class="text-right text-lg font-semibold mt-4">Total: Rp <span id="total">0</span></div>

      <!-- Metode Pembayaran -->
      <div>
        <label class="font-semibold block mb-1">Metode Pembayaran</label>
        <select id="metode" class="w-full border rounded-lg p-2">
          <option value="">Pilih...</option>
          <option value="Tunai">Tunai</option>
          <option value="Transfer">Transfer</option>
        </select>
      </div>

      <!-- Tambahan Transfer -->
      <div id="transfer-fields" class="hidden space-y-2">
        <input id="bank" placeholder="Nama Bank" class="w-full border rounded-lg p-2" />
        <input id="atasnama" placeholder="Atas Nama" class="w-full border rounded-lg p-2" />
        <input id="norek" placeholder="Nomor Rekening" class="w-full border rounded-lg p-2" />
      </div>

      <!-- Tombol kirim -->
      <button id="submit" class="w-full bg-green-600 text-white py-3 rounded-xl mt-4 hover:bg-green-700">Kirim Transaksi</button>

      <!-- Loading -->
      <div id="loading" class="hidden text-center mt-4 text-gray-600">‚è≥ Mengirim data...</div>
      <div id="notif" class="hidden text-center mt-4 text-green-600 font-semibold">‚úÖ Transaksi berhasil disimpan!</div>
    </div>

    <div class="text-center mt-6">
      <button onclick="window.location='index.html'" class="text-blue-600 hover:underline">‚Üê Kembali ke Menu</button>
    </div>
  </div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbzse_68vIKalKsWzE5fYyPzPCNm8mQ0gNEwzc0m7OW2O1BYOplkBOpoNmXVFbe78UY/exec";
    const type = new URLSearchParams(window.location.search).get("type");
    const title = document.getElementById("title");
    const transferFields = document.getElementById("transfer-fields");
    const metode = document.getElementById("metode");
    const barangList = document.getElementById("barang-list");
    const totalText = document.getElementById("total");
    const loading = document.getElementById("loading");
    const notif = document.getElementById("notif");

    title.textContent = type === "masuk" ? "üü¢ Transaksi Masuk" : "üî¥ Transaksi Keluar";

    let listBarang = [];
    let transaksiBarang = [];

    // Ambil ListBarang dari Sheet
    async function loadBarang() {
      const res = await fetch(SHEET_URL + "?action=getListBarang");
      listBarang = await res.json();
      addBarangForm(); // tampilkan form pertama
    }

    // Tambah form barang baru
    function addBarangForm() {
      const index = transaksiBarang.length;
      const div = document.createElement("div");
      div.className = "border p-3 rounded-lg space-y-2 bg-gray-100";
      div.innerHTML = `
        <select class="barang w-full border rounded-lg p-2">
          <option value="">Pilih Barang</option>
          ${listBarang.map(b => `<option value="${b.kode}">${b.nama}</option>`).join('')}
        </select>
        <input type="number" placeholder="Jumlah" class="jumlah w-full border rounded-lg p-2" min="1">
        <div>Harga: Rp <span class="harga">0</span></div>
        <div>Subtotal: Rp <span class="subtotal">0</span></div>
      `;
      barangList.appendChild(div);

      const barangSelect = div.querySelector(".barang");
      const jumlahInput = div.querySelector(".jumlah");
      const hargaText = div.querySelector(".harga");
      const subtotalText = div.querySelector(".subtotal");

      barangSelect.addEventListener("change", () => {
        const selected = listBarang.find(b => b.kode === barangSelect.value);
        if (!selected) return;
        hargaText.textContent = selected.harga;
        jumlahInput.value = "";
        subtotalText.textContent = "0";
      });

      jumlahInput.addEventListener("input", () => {
        const selected = listBarang.find(b => b.kode === barangSelect.value);
        if (!selected) return;
        const jumlah = parseInt(jumlahInput.value || 0);
        if (type === "keluar" && jumlah > selected.jumlah) {
          alert(`Stok tidak cukup! Sisa ${selected.jumlah}`);
          jumlahInput.value = selected.jumlah;
        }
        const subtotal = jumlah * selected.harga;
        subtotalText.textContent = subtotal.toLocaleString();
        updateTotal();
      });

      transaksiBarang.push(div);
    }

    document.getElementById("add-barang").addEventListener("click", addBarangForm);

    function updateTotal() {
      let total = 0;
      transaksiBarang.forEach(div => {
        const val = div.querySelector(".subtotal").textContent.replace(/\D/g, "");
        total += Number(val || 0);
      });
      totalText.textContent = total.toLocaleString();
    }

    metode.addEventListener("change", () => {
      transferFields.classList.toggle("hidden", metode.value !== "Transfer");
    });

    // Kirim ke Sheet
    document.getElementById("submit").addEventListener("click", async () => {
      const data = {
        action: type === "masuk" ? "addMasuk" : "addKeluar",
        metode: metode.value,
        bank: bank.value,
        atasnama: atasnama.value,
        norek: norek.value,
        items: transaksiBarang.map(div => {
          const kode = div.querySelector(".barang").value;
          const jumlah = parseInt(div.querySelector(".jumlah").value || 0);
          return { kode, jumlah };
        })
      };

      loading.classList.remove("hidden");
      notif.classList.add("hidden");

      const res = await fetch(SHEET_URL, {
        method: "POST",
        body: JSON.stringify(data)
      });

      loading.classList.add("hidden");
      notif.classList.remove("hidden");

      setTimeout(() => window.location = "index.html", 1500);
    });

    loadBarang();
  </script>
</body>
</html>
